<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WEALTH — Discover Properties</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f3f8f6; --card:#ffffff; --muted:#6b6f76; --accent:#1db07a; --accent-dark:#13a16a;
    --accent-2:#0c6; --score-bg:#fff4e6; --shadow:0 10px 30px rgba(15,23,42,0.06);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f1724;margin:0;background:linear-gradient(180deg,#f6fbfa 0%, #f3f8f6 100%)}
  header{display:flex;align-items:center;justify-content:space-between;padding:22px 40px;background:#fff;box-shadow:0 6px 18px rgba(12,18,26,0.04);position:sticky;top:0;z-index:40}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
  header h1{font-size:18px;margin:0}
  nav{display:flex;gap:18px;align-items:center}
  nav a{color:#334151;text-decoration:none;font-weight:600}
  .container{max-width:1150px;margin:28px auto;padding:0 18px}
  .hero{background:transparent;padding:38px 22px;border-radius:14px;margin-bottom:18px}
  .hero h2{font-size:44px;line-height:1;margin:0 0 12px;color:#0b2b1f}
  .hero p{margin:0 0 18px;color:var(--muted);font-size:17px}
  .searchRow{display:flex;gap:12px;align-items:center}
  .searchInput{flex:1;padding:14px 16px;border-radius:999px;border:2px solid rgba(13,65,37,0.06);background:#fff;font-size:16px;box-shadow:0 6px 20px rgba(12,18,26,0.02)}
  .aiBtn{background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#fff;padding:12px 18px;border-radius:999px;border:none;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(13,65,37,0.08)}
  .filters{display:flex;gap:12px;margin:18px 0;padding:18px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfffa);box-shadow:var(--shadow);align-items:center;flex-wrap:wrap}
  .filter{display:flex;flex-direction:column;gap:6px}
  .filter label{font-size:13px;color:var(--muted)}
  select,input[type=range]{padding:10px;border-radius:10px;border:1px solid #e9f0ec;background:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px;margin-top:18px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(12,18,26,0.04);display:flex;flex-direction:column;gap:10px}
  .card h3{margin:0;font-size:20px}
  .meta{font-size:13px;color:var(--muted)}
  .scoreLine{display:flex;align-items:center;gap:18px;justify-content:space-between}
  .scoreBig{display:flex;gap:12px;align-items:center}
  .scoreBox{background:var(--score-bg);border-radius:8px;padding:8px 12px;font-weight:800;color:#c96d00;min-width:72px;text-align:center;font-size:18px;box-shadow:inset 0 -6px 0 rgba(0,0,0,0.02)}
  .progressWrap{width:140px;height:8px;background:#e9f2ee;border-radius:999px;overflow:hidden}
  .progress{height:100%;background:linear-gradient(90deg,#ffd67a,#ff9a3a);width:40%}
  .card .info{font-size:13px;color:var(--muted)}
  .card .actions{display:flex;gap:10px;margin-top:8px}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(13,65,37,0.08)}
  footer{max-width:1150px;margin:30px auto;padding:0 18px;color:var(--muted);font-size:13px}

  /* diagnostic box */
  .diag{position:fixed;right:18px;bottom:18px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(12,18,26,0.12);width:360px;z-index:60}
  .diag h4{margin:0 0 8px 0;font-size:14px}
  .diag input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6efe9;margin-bottom:8px}
  .diag .log{background:#0b1220;color:#fff;padding:8px;border-radius:6px;font-family:monospace;font-size:12px;max-height:120px;overflow:auto}
  @media(max-width:900px){
    .hero h2{font-size:32px}
    .grid{grid-template-columns:1fr}
    header{padding:12px}
    .diag{width:92%}
  }
</style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">W</div>
      <div>
        <h1 style="margin:0">WEALTH</h1>
        <div style="font-size:12px;color:var(--muted)">Find homes that grow your wealth</div>
      </div>
    </div>
    <nav>
      <a href="#">Discover</a>
      <a href="#">Insights</a>
      <a href="#">Developers</a>
      <a href="#">Map View</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero">
      <h2>Find Homes That <span style="color:var(--accent)">Grow Your Wealth</span></h2>
      <p>Discover residential apartments in Hyderabad with high financial growth potential based on data-driven Wealth Scores</p>
      <div class="searchRow">
        <input id="searchInput" class="searchInput" placeholder="Try: Find me the best projects under ₹1 crore with high rent yield..." />
        <button class="aiBtn" id="aiSearch">AI Search</button>
      </div>
    </section>

    <section class="filters" aria-label="Filters">
      <div class="filter"><label>Zone</label><select id="zoneFilter"><option>All Zones</option><option>North</option><option>East</option><option>West</option><option>Central</option></select></div>
      <div class="filter"><label>Segment</label><select id="segmentFilter"><option>All Segments</option><option>Premium</option><option>Luxury</option><option>Affordable</option></select></div>
      <div class="filter"><label>Status</label><select id="statusFilter"><option>All Status</option><option>Ready</option><option>Under Construction</option></select></div>
      <div class="filter" style="margin-left:auto"><label>Min Wealth Score</label><select id="scoreFilter"><option value="0">Any Score</option><option value="70">≥ 70%</option><option value="50">≥ 50%</option></select></div>
    </section>

    <div style="color:var(--muted);margin:8px 0">Showing <span id="resultCount">0</span> properties</div>

    <section class="grid" id="cards"></section>
  </main>

  <footer>Tip: Set your API through the diagnostics panel (bottom right) to load real projects. Demo sample shown otherwise.</footer>

  <!-- Diagnostics -->
  <div class="diag" id="diag">
    <h4>Diagnostics / API</h4>
    <input id="apiUrl" placeholder="Paste Apps Script Exec URL (no ?json=1)" />
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn" id="saveBtn">Save & Test</button>
      <button class="btn ghost" id="clearBtn">Clear</button>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Status: <span id="diagStatus">idle</span></div>
    <div class="log" id="diagLog">(no output)</div>
  </div>

<script>
/* DATA + API + FRONTEND LOGIC
   - Set the API in the diagnostics box (stored to localStorage)
   - If API present it will GET ?json=1 and expect an array of projects
   - If no API or fetch fails, demo sample data is used so the UI looks like the screenshot
   - Wealth score engine is included and displayed as X.XX/10
*/

// ---------- Utilities ----------
const $ = id => document.getElementById(id);
function saveLog(text){ const l = $('diagLog'); l.textContent = (text + '\\n') + l.textContent; }
function setStatus(s){ $('diagStatus').textContent = s; }
function getApi(){ return localStorage.getItem('WEALTH_API_URL') || ''; }
function setApi(v){ if(!v) localStorage.removeItem('WEALTH_API_URL'); else localStorage.setItem('WEALTH_API_URL', v); }

// fetch with timeout and error handling
async function fetchWithTimeout(url, opts={}, timeout=12000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), timeout);
  try{
    const res = await fetch(url, {...opts, signal: controller.signal});
    clearTimeout(id);
    return res;
  } catch(e){
    clearTimeout(id); throw e;
  }
}

// ---------- Normalizers + safer parsing ----------
function parseNum(v, fallback = 0) {
  if (v === null || v === undefined || v === '') return fallback;
  if (typeof v === 'number' && !isNaN(v)) return v;
  // remove currency symbols, commas, spaces, percent signs, etc
  const s = String(v).replace(/[,₹\s%]+/g, '').replace(/[^\d\.\-]/g, '');
  const n = Number(s);
  return isNaN(n) ? fallback : n;
}

// normalize common alternative field names to our expected names
function normalizeProject(pRaw){
  const p = Object.assign({}, pRaw); // shallow copy
  // price fields: many APIs use min_price or minPrice or priceMin
  p.minPrice = parseNum(p.minPrice ?? p.min_price ?? p.min_price_rupee ?? p.minPriceInr ?? p.min_price_inr);
  p.maxPrice = parseNum(p.maxPrice ?? p.max_price ?? p.maxPriceInr ?? p.max_price_inr);
  // rent yield might be rentYieldPercent or rent_yield or avgRentYield
  p.rentYieldPercent = parseNum(p.rentYieldPercent ?? p.rent_yield ?? p.avgRentYield ?? p.avg_rent_yield);
  // units
  p.totalUnits = parseNum(p.totalUnits ?? p.total_units ?? p.totalUnitsBuilt ?? p.total_units_all, 0);
  p.unsoldUnits = parseNum(p.unsoldUnits ?? p.unsold_units ?? p.unsold, 0);
  // scores - try multiple names
  p.fundamentalsScore = parseNum(p.fundamentalsScore ?? p.fundamentalScore ?? p.fundamentals_score ?? p.fundScore, 0);
  p.environmentalScore = parseNum(p.environmentalScore ?? p.environmental_score ?? p.envScore, 0);
  p.locationScore = parseNum(p.locationScore ?? p.location_score ?? p.location_score_km ?? p.locScore, 0);
  p.personalScore = parseNum(p.personalScore ?? p.personal_score ?? p.personalScoreVal, 0);
  p.builderReputationScore = parseNum(p.builderReputationScore ?? p.builderReputation ?? p.builder_reputation_score ?? p.builder_score, 0);
  p.deliveryHistoryScore = parseNum(p.deliveryHistoryScore ?? p.delivery_history_score ?? p.delivery_score, 0);
  p.vacancyRiskScore = parseNum(p.vacancyRiskScore ?? p.vacancy_risk_score ?? p.vacancy_score, 0);
  p.safetyIndex = parseNum(p.safetyIndex ?? p.safety_index ?? p.safetyScore, 0);
  p.communityScore = parseNum(p.communityScore ?? p.community_profile_score ?? p.community_score, 0);

  // if the API directly provides a final wealthScore field, parse it too
  p.wealthScore = parseNum(p.wealthScore ?? p.wealth_score, null);

  return p;
}

// helpers used by score calculation
const L = (v) => Math.max(0, Math.min(1, Number(v) || 0));
function S10(v){ return L(Number(v) / 10); }
function invert10(v){ return L(1 - S10(v)); }
function affordability(minPrice, maxPrice){
  const min = parseNum(minPrice, 0), max = parseNum(maxPrice, 0);
  const avg = (min && max) ? ((min + max)/2) : (max || min || 0);
  if(!avg) return 0.5;
  const benchmark = 7500000; // tune for your market
  const ratio = avg / benchmark;
  const val = 1 - Math.log10(Math.max(ratio, 0.01)); // guard ratio
  return L(val);
}
function rentYieldScore(y){
  const num = parseNum(y, 0);
  return L(num / 8); // same scale as before
}
function demandScore(unsold, total){
  const u = parseNum(unsold, 0), t = parseNum(total, 0);
  if(!t) return 0.5;
  const ratio = u / t;
  return L(1 - ratio);
}

// compute wealth score from normalized project object
function computeWealthScoreP(raw){
  const p = normalizeProject(raw);
  // if API supplied final wealthScore, use that first (0..100)
  if (p.wealthScore !== null && p.wealthScore !== undefined) {
    // If API returned raw 0..10, scale to 0..100 if likely
    const v = p.wealthScore;
    if (v <= 10) return Math.round(L(v/10) * 100); // convert 0..10 to 0..100
    return Math.round(L(v/100) * 100);
  }

  const fFund = S10(p.fundamentalsScore);
  const fEnv = S10(p.environmentalScore);
  const fLoc = S10(p.locationScore);
  const fPers = S10(p.personalScore);
  const fBuilder = S10(p.builderReputationScore);
  const fDelivery = S10(p.deliveryHistoryScore);
  const fVacancy = invert10(p.vacancyRiskScore);
  const fSafety = S10(p.safetyIndex);
  const fCommunity = S10(p.communityScore);

  const fAff = affordability(p.minPrice, p.maxPrice);
  const fYield = rentYieldScore(p.rentYieldPercent);
  const fDemand = demandScore(p.unsoldUnits, p.totalUnits);

  // weights (kept similar)
  const w = {
    fundamentals:0.20, location:0.18, affordability:0.15, rentYield:0.10, builder:0.08, delivery:0.06,
    environmental:0.05, safety:0.05, vacancy:0.05, demand:0.04, personal:0.04
  };

  const score =
    fFund*w.fundamentals + fLoc*w.location + fAff*w.affordability + fYield*w.rentYield +
    fBuilder*w.builder + fDelivery*w.delivery + fEnv*w.environmental + fSafety*w.safety +
    fVacancy*w.vacancy + fDemand*w.demand + fPers*w.personal;

  // Debug logging for first project only (visible in diagnostics)
  try{
    if(window && window.lastLoaded && Array.isArray(window.lastLoaded) && window.lastLoaded[0] && (window.lastLoaded[0].projectId === (raw.projectId || raw.id || window.lastLoaded[0].projectId))) {
      const dbg = [
        `WEALTH DEBUG for projectId=${raw.projectId || raw.id || 'unknown'}`,
        `minPrice=${p.minPrice},maxPrice=${p.maxPrice},rentYield=${p.rentYieldPercent}`,
        `fundamentals:${p.fundamentalsScore}->${fFund.toFixed(3)}`,
        `location:${p.locationScore}->${fLoc.toFixed(3)}`,
        `afford:${fAff.toFixed(3)},rentYield:${fYield.toFixed(3)},demand:${fDemand.toFixed(3)}`,
        `builder:${p.builderReputationScore}->${fBuilder.toFixed(3)},delivery:${fDelivery.toFixed(3)},vacancy:${p.vacancyRiskScore}->${fVacancy.toFixed(3)}`,
        `rawScorePct:${(score*100).toFixed(2)}`
      ].join('\\n');
      setStatus('scoring-debug');
      saveLog(dbg);
    }
  }catch(e){ console.warn('debug log failed', e); }

  return Math.round(L(score) * 100);
}

// wrapper to return 0..10 format like earlier
function wealthToTen(rawProject){
  const pct = computeWealthScoreP(rawProject); // 0..100
  const val10 = Math.round((pct/10) * 100) / 100;
  return Math.max(0, Math.min(10, val10));
}


// ---------- Render UI ----------
function renderCards(arr){
  const container = $('cards'); container.innerHTML = '';
  const q = $('searchInput').value.trim().toLowerCase();
  const zone = $('zoneFilter').value;
  const segment = $('segmentFilter').value;
  const status = $('statusFilter').value;
  const minScoreFilter = Number($('scoreFilter').value || 0);

  const filtered = arr.filter(p=>{
    if(!p) return false;
    if(q && !(String(p.projectName||'').toLowerCase().includes(q) || String(p.microLocation||'').toLowerCase().includes(q))) return false;
    if(zone && zone!=='All Zones' && p.zone !== zone) return false;
    if(segment && segment!=='All Segments' && p.segment !== segment) return false;
    // status not used in demo; keep hook
    const s10 = Math.round((wealthToTen(p) * 10)); // 0..100
    if(minScoreFilter && s10 < minScoreFilter) return false;
    return true;
  });

  $('resultCount').textContent = filtered.length;

  filtered.forEach(p=>{
    const card = document.createElement('article'); card.className='card';
    const score10 = wealthToTen(p); // 0..10 with two decimals
    // progress percent for bar = score10 * 10 %
    const progPct = Math.round((score10/10)*100);
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <h3>${escapeHtml(p.projectName||p.projectId||'Unnamed')}</h3>
          <div class="meta">${escapeHtml(p.projectName ? p.projectName : '')}</div>
          <div class="meta">${escapeHtml(p.microLocation || '')} · ${escapeHtml(p.zone || '')}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:var(--muted)">Wealth Score</div>
          <div style="margin-top:6px;display:flex;align-items:center;gap:10px;justify-content:flex-end">
            <div class="scoreBox">${(score10).toFixed(2)}/10</div>
          </div>
        </div>
      </div>
      <div class="scoreLine">
        <div style="flex:1">
          <div style="height:10px;background:#eef6f2;border-radius:999px;overflow:hidden;margin-top:10px">
            <div class="progress" style="width:${progPct}%;background:linear-gradient(90deg,#ffd67a,#ff9a3a);height:100%"></div>
          </div>
        </div>
      </div>
      <div class="info">Price: ${formatMoney(p.minPrice)} - ${formatMoney(p.maxPrice)} · Avg Rent Yield: ${p.rentYieldPercent || 'N/A'}%</div>
      <div class="actions">
        <button class="btn" onclick="openLead('${escapeHtml(p.projectId||'')}')">Monitor</button>
        <button class="btn ghost" onclick="showDetails('${escapeHtml(p.projectId||'')}')">Details</button>
      </div>
    `;
    container.appendChild(card);
  });
}

function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[c])); }
function formatMoney(v){ if(!v && v!==0) return '—'; try { return '₹'+Number(v).toLocaleString(); } catch(e){ return '₹'+v; } }

// ---------- Actions ----------
function openLead(pid){ alert('Monitor lead for ' + pid); }
function showDetails(pid){ alert('Open details for ' + pid); }

// ---------- Load data ----------
async function loadProjects(){
  setStatus('loading');
  const api = getApi();
  if(!api){ // fallback demo
    setStatus('demo');
    saveLog('Using demo sample projects');
    const demo = demoProjects();
    renderCards(demo);
    return;
  }
  try{
    setStatus('fetching');
    saveLog('GET ' + api + '?json=1');
    const res = await fetchWithTimeout(api + '?json=1', {}, 12000);
    const text = await res.text();
    // attempt parse
    try{
      const data = JSON.parse(text);
      if(!Array.isArray(data)){
        saveLog('API returned non-array JSON; falling back to demo');
        setStatus('invalid-json');
        renderCards(demoProjects());
        return;
      }
      saveLog('Loaded ' + data.length + ' projects from API');
      setStatus('ok');
      renderCards(data);
      return;
    } catch(e){
      saveLog('JSON parse error: ' + e + '\\nResponse snippet: ' + text.slice(0,400));
      setStatus('parse-error');
      renderCards(demoProjects());
      return;
    }
  } catch(e){
    saveLog('Fetch error: ' + String(e));
    setStatus('error');
    renderCards(demoProjects());
    return;
  }
}

// ---------- Init UI ----------
$('apiUrl').value = getApi();
$('saveBtn').addEventListener('click', ()=>{
  const v = $('apiUrl').value.trim();
  if(!v){ setApi(''); saveLog('Cleared API'); setStatus('cleared'); loadProjects(); return; }
  setApi(v); saveLog('Saved API: ' + v); setStatus('saved'); loadProjects();
});
$('clearBtn').addEventListener('click', ()=>{ $('apiUrl').value=''; setApi(''); saveLog('Cleared API'); setStatus('cleared'); loadProjects(); });
$('searchInput').addEventListener('input', ()=> loadProjectsFromCache());
['zoneFilter','segmentFilter','statusFilter','scoreFilter'].forEach(id => $(id).addEventListener('change', ()=> loadProjectsFromCache()));

let lastLoaded = null;
async function loadProjectsFromCache(){
  // If an API was used earlier, we should fetch again; for performance we keep lastLoaded if exists and filter it
  if(lastLoaded && Array.isArray(lastLoaded) && lastLoaded.length) {
    renderCards(lastLoaded);
  } else {
    await loadProjects();
  }
}

// override to store lastLoaded when API returns
const origRenderCards = renderCards;
renderCards = function(arr){
  lastLoaded = arr;
  origRenderCards(arr);
};

(function init(){
  loadProjects();
})();
</script>
</body>
</html>
