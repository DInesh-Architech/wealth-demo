<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WEALTH — Discover Properties</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f3f8f6; --card:#ffffff; --muted:#6b6f76; --accent:#1db07a; --accent-dark:#13a16a;
    --score-bg:#fff4e6; --shadow:0 10px 30px rgba(15,23,42,0.06);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f1724;margin:0;background:linear-gradient(180deg,#f6fbfa 0%, #f3f8f6 100%)}
  header{display:flex;align-items:center;justify-content:space-between;padding:22px 40px;background:#fff;box-shadow:0 6px 18px rgba(12,18,26,0.04);position:sticky;top:0;z-index:40}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
  header h1{font-size:18px;margin:0}
  nav{display:flex;gap:18px;align-items:center}
  nav a{color:#334151;text-decoration:none;font-weight:600}
  .container{max-width:1150px;margin:28px auto;padding:0 18px}
  .hero{background:transparent;padding:38px 22px;border-radius:14px;margin-bottom:18px}
  .hero h2{font-size:44px;line-height:1;margin:0 0 12px;color:#0b2b1f}
  .hero p{margin:0 0 18px;color:var(--muted);font-size:17px}
  .searchRow{display:flex;gap:12px;align-items:center}
  .searchInput{flex:1;padding:14px 16px;border-radius:999px;border:2px solid rgba(13,65,37,0.06);background:#fff;font-size:16px;box-shadow:0 6px 20px rgba(12,18,26,0.02)}
  .aiBtn{background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#fff;padding:12px 18px;border-radius:999px;border:none;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(13,65,37,0.08)}
  .filters{display:flex;gap:12px;margin:18px 0;padding:18px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfffa);box-shadow:var(--shadow);align-items:center;flex-wrap:wrap}
  .filter{display:flex;flex-direction:column;gap:6px}
  .filter label{font-size:13px;color:var(--muted)}
  select,input[type=range]{padding:10px;border-radius:10px;border:1px solid #e9f0ec;background:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px;margin-top:18px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(12,18,26,0.04);display:flex;flex-direction:column;gap:10px}
  .card h3{margin:0;font-size:20px}
  .meta{font-size:13px;color:var(--muted)}
  .scoreLine{display:flex;align-items:center;gap:18px;justify-content:space-between}
  .scoreBig{display:flex;gap:12px;align-items:center}
  .scoreBox{background:var(--score-bg);border-radius:8px;padding:8px 12px;font-weight:800;color:#c96d00;min-width:72px;text-align:center;font-size:18px;box-shadow:inset 0 -6px 0 rgba(0,0,0,0.02)}
  .progressWrap{width:140px;height:8px;background:#e9f2ee;border-radius:999px;overflow:hidden}
  .progress{height:100%;background:linear-gradient(90deg,#ffd67a,#ff9a3a);width:40%}
  .card .info{font-size:13px;color:var(--muted)}
  .card .actions{display:flex;gap:10px;margin-top:8px}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(13,65,37,0.08)}
  footer{max-width:1150px;margin:30px auto;padding:0 18px;color:var(--muted);font-size:13px}
  .diag{position:fixed;right:18px;bottom:18px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(12,18,26,0.12);width:360px;z-index:60}
  .diag h4{margin:0 0 8px 0;font-size:14px}
  .diag input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6efe9;margin-bottom:8px}
  .diag .log{background:#0b1220;color:#fff;padding:8px;border-radius:6px;font-family:monospace;font-size:12px;max-height:180px;overflow:auto}
  @media(max-width:900px){
    .hero h2{font-size:32px}
    .grid{grid-template-columns:1fr}
    header{padding:12px}
    .diag{width:92%}
  }
</style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">W</div>
      <div>
        <h1 style="margin:0">WEALTH</h1>
        <div style="font-size:12px;color:var(--muted)">Find homes that grow your wealth</div>
      </div>
    </div>
    <nav>
      <a href="#">Discover</a>
      <a href="#">Insights</a>
      <a href="#">Developers</a>
      <a href="#">Map View</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero">
      <h2>Find Homes That <span style="color:var(--accent)">Grow Your Wealth</span></h2>
      <p>Discover residential apartments in Hyderabad with high financial growth potential based on data-driven Wealth Scores</p>
      <div class="searchRow">
        <input id="searchInput" class="searchInput" placeholder="Try: Find me the best projects under ₹1 crore with high rent yield..." />
        <button class="aiBtn" id="aiSearch">AI Search</button>
      </div>
    </section>

    <section class="filters" aria-label="Filters">
      <div class="filter"><label>Zone</label><select id="zoneFilter"><option>All Zones</option><option>North</option><option>East</option><option>West</option><option>Central</option></select></div>
      <div class="filter"><label>Segment</label><select id="segmentFilter"><option>All Segments</option><option>Premium</option><option>Luxury</option><option>Affordable</option></select></div>
      <div class="filter"><label>Status</label><select id="statusFilter"><option>All Status</option><option>Ready</option><option>Under Construction</option></select></div>
      <div class="filter" style="margin-left:auto"><label>Min Wealth Score</label><select id="scoreFilter"><option value="0">Any Score</option><option value="70">≥ 70%</option><option value="50">≥ 50%</option></select></div>
    </section>

    <div style="color:var(--muted);margin:8px 0">Showing <span id="resultCount">0</span> properties</div>

    <section class="grid" id="cards"></section>
  </main>

  <footer>Tip: Set your API through the diagnostics panel (bottom right) to load real projects. Demo sample shown otherwise.</footer>

  <!-- Diagnostics -->
  <div class="diag" id="diag">
    <h4>Diagnostics / API</h4>
    <input id="apiUrl" placeholder="Paste Apps Script Exec URL (no ?json=1)" />
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn" id="saveBtn">Save & Test</button>
      <button class="btn ghost" id="clearBtn">Clear</button>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Status: <span id="diagStatus">idle</span></div>
    <div class="log" id="diagLog">(no output)</div>
  </div>

<script>
/* Robust frontend + wealth scoring engine.
   Replace your index.html with this complete file.
*/

// utilities
const $ = id => document.getElementById(id);
function saveLog(text){ const l = $('diagLog'); l.textContent = (new Date()).toISOString() + ' ' + text + '\\n' + l.textContent; }
function setStatus(s){ $('diagStatus').textContent = s; }
function getApi(){ return localStorage.getItem('WEALTH_API_URL') || ''; }
function setApi(v){ if(!v) localStorage.removeItem('WEALTH_API_URL'); else localStorage.setItem('WEALTH_API_URL', v); }

// fetch with timeout
async function fetchWithTimeout(url, opts={}, timeout=12000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), timeout);
  try{
    const res = await fetch(url, {...opts, signal: controller.signal});
    clearTimeout(id);
    return res;
  } catch(e){
    clearTimeout(id); throw e;
  }
}

// parse number safely
function parseNum(v, fallback = 0) {
  if (v === null || v === undefined || v === '') return fallback;
  if (typeof v === 'number' && !isNaN(v)) return v;
  const s = String(v).replace(/[,₹\s%]+/g, '').replace(/[^\d\.\-]/g, '');
  const n = Number(s);
  return isNaN(n) ? fallback : n;
}

// normalize API fields
function normalizeProject(pRaw){
  const p = Object.assign({}, pRaw);

  p.minPrice = parseNum(p.minPrice ?? p.min_price ?? p.minPriceInr ?? p.min_price_inr ?? p.min);
  p.maxPrice = parseNum(p.maxPrice ?? p.max_price ?? p.maxPriceInr ?? p.max_price_inr ?? p.max);
  p.rentYieldPercent = parseNum(p.rentYieldPercent ?? p.avgRentYield ?? p.rent_yield ?? p.rentYieldPercent);
  p.totalUnits = parseNum(p.totalUnits ?? p.total_units ?? p.totalUnitsBuilt ?? p.unitsTotal ?? p.total);
  p.unsoldUnits = parseNum(p.unsoldUnits ?? p.unsold ?? p.unsold_units ?? p.inventory);
  p.fundamentalsScore = parseNum(p.fundamentalsScore ?? p.fundamentals ?? p.fundamentalScore);
  p.environmentalScore = parseNum(p.environmentalScore ?? p.env ?? p.environment_score);
  p.locationScore = parseNum(p.locationScore ?? p.location ?? p.location_score);
  p.personalScore = parseNum(p.personalScore ?? p.personal_score ?? p.personalScoreVal);
  p.builderReputationScore = parseNum(p.builderReputationScore ?? p.builder ?? p.builder_score);
  p.deliveryHistoryScore = parseNum(p.deliveryHistoryScore ?? p.delivery ?? p.delivery_score);
  p.vacancyRiskScore = parseNum(p.vacancyRiskScore ?? p.vacancy ?? p.vacancy_risk_score);
  p.safetyIndex = parseNum(p.safetyIndex ?? p.safety ?? p.safety_score);
  p.communityScore = parseNum(p.communityScore ?? p.community ?? p.community_score);
  p.wealthScore = (p.wealthScore !== undefined && p.wealthScore !== null) ? parseNum(p.wealthScore, null) : null;

  // keep raw strings for UI
  return p;
}

// small helpers
const L = (v) => Math.max(0, Math.min(1, Number(v) || 0));
function S10(v){ return L(Number(v) / 10); }
function invert10(v){ return L(1 - S10(v)); }
function affordability(minPrice, maxPrice){
  const min = parseNum(minPrice, 0), max = parseNum(maxPrice, 0);
  const avg = (min && max) ? ((min + max)/2) : (max || min || 0);
  if(!avg) return 0.5;
  const benchmark = 7500000;
  const ratio = avg / benchmark;
  const val = 1 - Math.log10(Math.max(ratio, 0.01));
  return L(val);
}
function rentYieldScore(y){
  const num = parseNum(y, 0);
  return L(num / 8);
}
function demandScore(unsold, total){
  const u = parseNum(unsold, 0), t = parseNum(total, 0);
  if(!t) return 0.5;
  const ratio = u / t;
  return L(1 - ratio);
}

// ---------- compute wealth score (use API demand/yield fallbacks) ----------
function computeWealthScoreP(raw){
  const p = normalizeProject(raw);

  // use API-provided wealth directly if present
  if (p.wealthScore !== null && p.wealthScore !== undefined) {
    const v = Number(p.wealthScore) || 0;
    if (v <= 10) return Math.round(L(v/10) * 100);
    return Math.round(L(v/100) * 100);
  }

  // helpers
  const safe = x => (typeof x === 'number' ? x : parseFloat(x) || 0);
  function rentYieldFallback(){
    if(p.rentYieldPercent) return safe(p.rentYieldPercent);
    // try avgRent2BHK and avgRent3BHK to derive yield using pricePerSqft & typical sizes is hard;
    // fallback: if avgRent2BHK & avgRent3BHK exist, average and estimate yield using minPrice avg
    const r2 = safe(raw.avgRent2BHK || raw.avgRent2BHK || 0);
    const r3 = safe(raw.avgRent3BHK || 0);
    const avgRent = (r2 && r3) ? ((r2 + r3)/2) : (r2 || r3 || 0);
    if(!avgRent) return 0;
    // crude estimate: assume annual rent = avgRent*12 for a 2B/3B; compare to average price
    const avgPrice = (safe(p.minPrice) + safe(p.maxPrice)) / ( (safe(p.minPrice) && safe(p.maxPrice)) ? 2 : 1 );
    if(!avgPrice) return 0;
    const yieldPct = (avgRent * 12) / avgPrice * 100;
    return yieldPct;
  }

  // compute components
  const fFund = S10(safe(p.fundamentalsScore));
  const fLoc  = S10(safe(p.locationScore));
  const fBuilder = S10(safe(p.builderReputationScore));
  const fDelivery = S10(safe(p.deliveryHistoryScore));
  const fEnv = S10(safe(p.environmentalScore));
  const fSafety = S10(safe(p.safetyIndex));
  const fPers = S10(safe(p.personalScore));
  const fVacancy = invert10(safe(p.vacancyRiskScore));

  const fAff = affordability(safe(p.minPrice), safe(p.maxPrice));
  const rawYield = rentYieldFallback();
  const fYield = rentYieldScore(rawYield);

  // demand: prefer rentalDemandScore if present (scale 0..10 assumed), else unsold/total
  let fDemand = 0.5;
  if(raw.rentalDemandScore !== undefined && raw.rentalDemandScore !== null){
    fDemand = L(safe(raw.rentalDemandScore)/10);
  } else {
    // clamp unsold to total
    const total = safe(p.totalUnits);
    let unsold = safe(p.unsoldUnits);
    if(total > 0 && unsold > total) unsold = total;
    fDemand = demandScore(unsold, total);
  }

  const w = {
    fundamentals:0.20, location:0.18, affordability:0.15, rentYield:0.10, builder:0.08, delivery:0.06,
    environmental:0.05, safety:0.05, vacancy:0.05, demand:0.04, personal:0.04
  };

  const score =
    fFund*w.fundamentals + fLoc*w.location + fAff*w.affordability + fYield*w.rentYield +
    fBuilder*w.builder + fDelivery*w.delivery + fEnv*w.environmental + fSafety*w.safety +
    fVacancy*w.vacancy + fDemand*w.demand + fPers*w.personal;

  // debug snapshot to diag
  try{
    const rawId = raw.projectId || raw.id || 'unknown';
    saveLog(`SCORES ${rawId}: aff=${fAff.toFixed(3)},yield=${fYield.toFixed(3)},demand=${fDemand.toFixed(3)},safety=${fSafety.toFixed(3)} => rawScorePct=${(Math.max(0,Math.min(1,score))*100).toFixed(2)}`);
    setStatus('scoring-debug');
  } catch(e){}

  return Math.round(Math.max(0,Math.min(1,score)) * 100);
}

// wrapper
function wealthToTen(rawProject){
  const pct = computeWealthScoreP(rawProject);
  return Math.max(0, Math.min(10, Math.round((pct/10) * 100) / 100));
}


// wrapper to return 0..10 format like earlier
function wealthToTen(rawProject){
  const pct = computeWealthScoreP(rawProject); // 0..100
  const val10 = Math.round((pct/10) * 100) / 100;
  return Math.max(0, Math.min(10, val10));
}

// ---------- Render UI ----------
function renderCards(arr){
  const container = $('cards'); container.innerHTML = '';
  const q = $('searchInput').value.trim().toLowerCase();
  const zone = $('zoneFilter').value;
  const segment = $('segmentFilter').value;
  const status = $('statusFilter').value;
  const minScoreFilter = Number($('scoreFilter').value || 0);

  const filtered = (arr||[]).filter(p=>{
    if(!p) return false;
    if(q && !(String(p.projectName||'').toLowerCase().includes(q) || String(p.microLocation||'').toLowerCase().includes(q))) return false;
    if(zone && zone!=='All Zones' && p.zone !== zone) return false;
    if(segment && segment!=='All Segments' && p.segment !== segment) return false;
    const s10 = Math.round((wealthToTen(p) * 10));
    if(minScoreFilter && s10 < minScoreFilter) return false;
    return true;
  });

  $('resultCount').textContent = filtered.length;

  filtered.forEach(p=>{
    const card = document.createElement('article'); card.className='card';
    const score10 = wealthToTen(p);
    const progPct = Math.round((score10/10)*100);
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <h3>${escapeHtml(p.projectName||p.projectId||'Unnamed')}</h3>
          <div class="meta">${escapeHtml(p.projectName ? p.projectName : '')}</div>
          <div class="meta">${escapeHtml(p.microLocation || '')} · ${escapeHtml(p.zone || '')}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:var(--muted)">Wealth Score</div>
          <div style="margin-top:6px;display:flex;align-items:center;gap:10px;justify-content:flex-end">
            <div class="scoreBox">${(score10).toFixed(2)}/10</div>
          </div>
        </div>
      </div>
      <div class="scoreLine">
        <div style="flex:1">
          <div style="height:10px;background:#eef6f2;border-radius:999px;overflow:hidden;margin-top:10px">
            <div class="progress" style="width:${progPct}%;background:linear-gradient(90deg,#ffd67a,#ff9a3a);height:100%"></div>
          </div>
        </div>
      </div>
      <div class="info">Price: ${formatMoney(p.minPrice)} - ${formatMoney(p.maxPrice)} · Avg Rent Yield: ${p.rentYieldPercent || 'N/A'}%</div>
      <div class="actions">
        <button class="btn" onclick="openLead('${escapeHtml(p.projectId||'')}')">Monitor</button>
        <button class="btn ghost" onclick="showDetails('${escapeHtml(p.projectId||'')}')">Details</button>
      </div>
    `;
    container.appendChild(card);
  });
}

function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[c])); }
function formatMoney(v){ if(v===null||v===undefined) return '—'; try { return '₹'+Number(v).toLocaleString(); } catch(e){ return '₹'+v; } }

// actions
function openLead(pid){ alert('Monitor lead for ' + pid); }
function showDetails(pid){ alert('Open details for ' + pid); }

// load projects
async function loadProjects(){
  setStatus('loading');
  const api = getApi();
  if(!api){
    setStatus('demo');
    saveLog('Using demo sample projects');
    const demo = demoProjects();
    renderCards(demo);
    return;
  }
  try{
    setStatus('fetching');
    saveLog('GET ' + api + '?json=1');
    const res = await fetchWithTimeout(api + '?json=1', {}, 12000);
    const text = await res.text();
    try{
      const data = JSON.parse(text);
      if(!Array.isArray(data)){
        saveLog('API returned non-array JSON; falling back to demo');
        setStatus('invalid-json');
        renderCards(demoProjects());
        return;
      }
      saveLog('Loaded ' + data.length + ' projects from API');
      setStatus('ok');
      renderCards(data);
      return;
    } catch(e){
      saveLog('JSON parse error: ' + e + '\\nResponse snippet: ' + (text||'').slice(0,400));
      setStatus('parse-error');
      renderCards(demoProjects());
      return;
    }
  } catch(e){
    saveLog('Fetch error: ' + String(e));
    setStatus('error');
    renderCards(demoProjects());
    return;
  }
}

// demo sample (keeps UI populated if API unreachable)
function demoProjects(){
  return [
    {
      projectId:'P001', projectName:'Skyline Aurelia', microLocation:'Kondapur', zone:'North',
      minPrice:7600000, maxPrice:9800000, rentYieldPercent:2.85, totalUnits:181, unsoldUnits:20,
      fundamentalsScore:6, locationScore:6, builderReputationScore:6, safetyIndex:5
    },
    {
      projectId:'P002', projectName:'Cypress Urban Retreat', microLocation:'Uppal', zone:'North',
      minPrice:12800000, maxPrice:19800000, rentYieldPercent:2.09, totalUnits:280, unsoldUnits:70,
      fundamentalsScore:5, locationScore:5, builderReputationScore:4, safetyIndex:4
    }
  ];
}

// init UI
$('apiUrl').value = getApi();
$('saveBtn').addEventListener('click', ()=>{
  const v = $('apiUrl').value.trim();
  if(!v){ setApi(''); saveLog('Cleared API'); setStatus('cleared'); loadProjects(); return; }
  setApi(v); saveLog('Saved API: ' + v); setStatus('saved'); loadProjects();
});
$('clearBtn').addEventListener('click', ()=>{ $('apiUrl').value=''; setApi(''); saveLog('Cleared API'); setStatus('cleared'); loadProjects(); });
$('searchInput').addEventListener('input', ()=> loadProjectsFromCache());
['zoneFilter','segmentFilter','statusFilter','scoreFilter'].forEach(id => $(id).addEventListener('change', ()=> loadProjectsFromCache()));

let lastLoaded = null;
async function loadProjectsFromCache(){
  if(lastLoaded && Array.isArray(lastLoaded) && lastLoaded.length) {
    renderCards(lastLoaded);
  } else {
    await loadProjects();
  }
}

// override to capture lastLoaded
const origRenderCards = renderCards;
renderCards = function(arr){
  lastLoaded = arr;
  origRenderCards(arr);
};

(function init(){ loadProjects(); })();
</script>
</body>
</html>
